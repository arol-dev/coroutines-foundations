/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example

import kotlinx.coroutines.*
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableSharedFlow
import kotlinx.coroutines.flow.lastOrNull

data class User(val username: String, val friends: List<User> = emptyList())

class InMemoryDatabase {
    private val _userFlow = MutableSharedFlow<User>()
    val userFlow: Flow<User> = _userFlow

    suspend fun setCurrentUser(user: User) = _userFlow.emit(user)

    suspend fun getCurrentUser(): User? {
        return _userFlow.lastOrNull()
    }
}

class App {
    suspend fun doLogin(username: String, password: String): User {
        // Server request
        return User(username)
    }

    suspend fun requestCurrentFriends(user: User): List<User> {
        // Server request
        return listOf(User("1"), User("2"))
    }

    suspend fun requestSuggestedFriends(user: User): List<User> {
        // Server request
        return listOf(User("3"), User("4"))
    }
}

@OptIn(DelicateCoroutinesApi::class)
fun main() {
    val app = App()
    val inMemoryDatabase = InMemoryDatabase()

    val coroutineScope = CoroutineScope(Dispatchers.Default + SupervisorJob())

    coroutineScope.launch {
        inMemoryDatabase.getCurrentUser()?.let { currentUser ->
            println("Current user: $currentUser")
        }
    }

    coroutineScope.launch {
        val user1 = app.doLogin("user1", "password")
        inMemoryDatabase.setCurrentUser(user1)
        val user2 = app.doLogin("user2", "password")
        inMemoryDatabase.setCurrentUser(user2)
        inMemoryDatabase.getCurrentUser()?.let { currentUser ->
            println("Current user: $currentUser")
        }
    }

    coroutineScope.launch {
        inMemoryDatabase.userFlow.collect { user ->
            println("User: $user")
        }
    }

    runBlocking {
        coroutineScope.coroutineContext.job.join()
    }
}
